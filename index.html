<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCV.js Playing Card Detection</title>
    <script async src="https://docs.opencv.org/master/opencv.js" type="text/javascript"></script>
</head>
<body>
    <input type="file" id="fileInput">
    <canvas id="canvasOutput"></canvas>

    <script type="text/javascript">
        let src, dst;
        const canvasOutput = document.getElementById('canvasOutput');
        const fileInput = document.getElementById('fileInput');

        fileInput.onchange = function (e) {
            let img = new Image();
            img.onload = function () {
                canvasOutput.width = img.width;
                canvasOutput.height = img.height;
                let ctx = canvasOutput.getContext('2d');
                ctx.drawImage(img, 0, 0, img.width, img.height);

                console.log('Image loaded successfully.');

                // Load the image into OpenCV
                src = cv.imread(canvasOutput);
                dst = new cv.Mat();

                console.log('Image read into OpenCV.');

                // Convert to grayscale
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
                console.log('Image converted to grayscale.');

                // Apply Canny edge detection
                cv.Canny(dst, dst, 50, 150);
                console.log('Canny edge detection applied.');

                // Find contours
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                console.log('Contours found: ', contours.size());

                // Step 1: Draw all contours for visual feedback
                let allContoursColor = new cv.Scalar(255, 0, 0, 255); // Red for all contours
                cv.drawContours(src, contours, -1, allContoursColor, 2);

                // Loop through the contours to find rectangles (potential cards)
                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let perimeter = cv.arcLength(cnt, true);
                    let approx = new cv.Mat();
                    cv.approxPolyDP(cnt, approx, 0.02 * perimeter, true);

                    // If we have found a quadrilateral (4 corners)
                    if (approx.rows === 4) {
                        console.log('Quadrilateral detected.');

                        // Step 2: Draw quadrilateral contours in green
                        let quadColor = new cv.Scalar(0, 255, 0, 255); // Green for quadrilaterals
                        cv.drawContours(src, contours, i, quadColor, 2);

                        // Extract the points of the quadrilateral
                        let points = [];
                        for (let j = 0; j < 4; j++) {
                            let point = approx.data32S.slice(j * 2, j * 2 + 2);
                            points.push({ x: point[0], y: point[1] });
                        }

                        // Define destination points for a warped image (standard playing card size)
                        let cardWidth = 200, cardHeight = 300;
                        let dstPoints = [
                            new cv.Point(0, 0),
                            new cv.Point(cardWidth - 1, 0),
                            new cv.Point(cardWidth - 1, cardHeight - 1),
                            new cv.Point(0, cardHeight - 1)
                        ];

                        // Apply perspective transformation
                        let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [].concat(...points.map(p => [p.x, p.y])));
                        let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [].concat(...dstPoints.map(p => [p.x, p.y])));
                        let M = cv.getPerspectiveTransform(srcTri, dstTri);

                        let warped = new cv.Mat();
                        cv.warpPerspective(src, warped, M, new cv.Size(cardWidth, cardHeight));

                        console.log('Perspective transformation applied.');

                        // Step 3: Display the warped image (the playing card)
                        cv.imshow('canvasOutput', warped);

                        // Clean up
                        srcTri.delete();
                        dstTri.delete();
                        M.delete();
                        warped.delete();
                    }
                    approx.delete();
                }

                contours.delete();
                hierarchy.delete();

                // Show the image with all detected contours and quadrilaterals drawn
                cv.imshow('canvasOutput', src);
            };
            img.src = URL.createObjectURL(e.target.files[0]);
        };
    </script>
</body>
</html>
